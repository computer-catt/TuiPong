@inject IJSRuntime JavascriptRuntime
@page "/"
@inject NavigationManager NavigationManager
@using TuiCommon
@using TuiCommon.Applications

<PageTitle>Home</PageTitle>

<div tabindex="0" @onkeydown="HandleKey" style="color: white;">
    <div style="color: white; white-space: pre-wrap;">@_screenText</div>
</div>

@code {
    WebScreen? _webScreen;
    private string _screenText = "";
    private PixelSize? _characterSize;
    private int _horizontalCharacters;
    private int _verticalCharacters;
    
    protected override async void OnInitialized() {
        List<string> args = ["ManualScreenWrap", "DisableColors"];
        args.AddRange(new Uri(NavigationManager.Uri).Query.TrimStart('?').Trim().Replace("%20", " ").Split(' ', StringSplitOptions.RemoveEmptyEntries));
        
        _webScreen = new WebScreen(s => {
            _screenText = s;
            StateHasChanged();
        });
        
        _webScreen.SetArgs(args.ToArray());
        
        await UpdateSize();
        _webScreen.SetScreenBounds(_horizontalCharacters, _verticalCharacters);
        TuiApplication game = new Pong(_webScreen);
        _webScreen.SetApplication(game);
        _webScreen.StartScreen();
        _ = ScreenCheckLoop();

    }

    private async Task ScreenCheckLoop() {
        while (true) {
            await UpdateSize();
            _webScreen?.SetScreenBounds(_horizontalCharacters, _verticalCharacters);
            await Task.Delay(100);
        }
    }
    
    private async Task UpdateSize() {
        _characterSize = await JavascriptRuntime.InvokeAsync<PixelSize>("measureCharacter");
        var viewportSize = await JavascriptRuntime.InvokeAsync<PixelSize>("getViewportSize");
        _horizontalCharacters = (int)(viewportSize.Width / (_characterSize.Width / 10f));
        _verticalCharacters = viewportSize.Height / _characterSize.Height;
    }
    
    private void HandleKey(KeyboardEventArgs args) =>
        _webScreen?.SendKey(new TuiKey(args.Key, args.Code));
    
    public class PixelSize {
        public int Width { get; set; }
        public int Height { get; set; }
    }
}
